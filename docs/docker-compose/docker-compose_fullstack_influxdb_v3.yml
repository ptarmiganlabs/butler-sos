# docker-compose_fullstack_influxdb_v3.yml
# InfluxDB v3.x (Core) - using the InfluxDB 3.x Community Edition
version: "3.3"
services:
    butler-sos:
        image: ptarmiganlabs/butler-sos:latest
        container_name: butler-sos
        restart: always
        volumes:
            # Make config file and log files accessible outside of container
            - "./config:/nodeapp/config"
            - "./log:/nodeapp/log"
        environment:
            - "NODE_ENV=production_influxdb_v3" # Means that Butler SOS will read config data from production_influxdb_v3.yaml
        logging:
            driver: "json-file"
            options:
                max-file: "5"
                max-size: "5m"
        networks:
            - senseops

    influxdb:
        # Note: InfluxDB v3 Core is available as influxdb3 image
        # For production use, consider InfluxDB Cloud or Enterprise
        image: influxdb:latest
        container_name: influxdb-v3
        restart: always
        volumes:
            - ./influxdb/data:/var/lib/influxdb3 # Mount for influxdb data directory
            - ./influxdb/config/:/etc/influxdb3/ # Mount for influxdb configuration
        ports:
            # The API for InfluxDB is served on port 8086
            - "8086:8086"
        environment:
            # InfluxDB v3 setup - uses similar setup to v2 but different internal architecture
            - "DOCKER_INFLUXDB_INIT_MODE=setup"
            - "DOCKER_INFLUXDB_INIT_USERNAME=admin"
            - "DOCKER_INFLUXDB_INIT_PASSWORD=butlersos123"
            - "DOCKER_INFLUXDB_INIT_ORG=butler-sos"
            - "DOCKER_INFLUXDB_INIT_BUCKET=butler-sos"
            - "DOCKER_INFLUXDB_INIT_DATABASE=butler-sos" # v3 uses database concept
            - "DOCKER_INFLUXDB_INIT_RETENTION=10d"
            - "DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=butlersos-token"
        networks:
            - senseops

    grafana:
        image: grafana/grafana:latest
        container_name: grafana
        restart: always
        ports:
            - "3000:3000"
        volumes:
            - ./grafana/data:/var/lib/grafana
        networks:
            - senseops

networks:
    senseops:
        driver: bridge